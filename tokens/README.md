# Joe Design System – Tokens

This folder is the **single source of truth** for design token.

Generated output is used by: **Next.js** and **Storybook**, and by **`app/globals.css`**.

## Files

| File | Role |
|------|------|
| `joe-tokens.json` | Source tokens (W3C format). Edited by designers/devs or synced from Figma (e.g. Token Studio). |
| `joe-tokens-legacy.json` | Legacy-format copy for Token Studio (optional). Generated by `npm run tokens:build`. Only needed if you use Token Studio to sync code → Figma. For **Obra → Storybook** workflow you can ignore this file; see [OBRA_WORKFLOW.md](OBRA_WORKFLOW.md). |
| `output/css/variables.css` | Generated CSS custom properties (DO NOT EDIT THIS!!). |
| `output/tailwind/theme.cjs` | Generated Tailwind theme (DO NOT EDIT THIS!!!). |

Generated files are produced by `npm run tokens:build` (see `scripts/build-tokens.mjs`). The build also generates `joe-tokens-legacy.json` for Figma/Token Studio.

## Recommended approach: Figma + Storybook in sync

**Goals:** Storybook keeps working, tokens stay in sync with Figma, and designers get **semantics referencing primitives** in Figma via Token Studio’s supported workflow.

### Why Do We Have joe-tokens.json And joe-tokens-legacy.json

- **Single source of truth:** `joe-tokens.json` (W3C). Build produces CSS, Tailwind theme, **and** `joe-tokens-legacy.json`.
- **Storybook:** Uses `tokens/output/` from `tokens:build`; no dependency on Legacy.
- **Figma / designers:** Token Studio syncs from **`tokens/joe-tokens-legacy.json`** with **Token format = Legacy**. The legacy file matches the working structure: **only** `primitives` and `semantic` (no `$metadata` or `$themes`), references as `{primitives.colors.white}`. **`joe-tokens.json`** is unchanged; Storybook and the build pipeline use it as-is. After any change to `joe-tokens.json`, run **`npm run tokens:build`** and commit; designers pull and re-export to Figma.

### Two collections: primitives + semantic (Variables panel references)

- **Working structure:** Your previous token set had **two** top-level keys (`primitives`, `semantic`), Legacy format, no `$metadata`/`$themes`, and references like `{primitives.colors.white}`. That produced two Figma variable collections with semantic Variables referencing primitive Variables. The legacy export now outputs that **exact shape**.
- **What we do:** **`joe-tokens-legacy.json`** contains only `primitives` and `semantic`; references stay as `{primitives.xxx}`. No single-set merge, no `$metadata.tokenSetOrder`.
- **Color: Variables vs Styles:** In Export Options, **Color** can be exported as either **Variables** or **Styles**, not both. For semantics as **Variables** referencing primitives, keep **Variables → Color** on and **Styles → Color** off.

### Designer workflow (Figma) – semantics as Variables referencing primitives

1. **Sync**: Token Studio → connect to repo, path **`tokens/joe-tokens-legacy.json`**, **Token format = Legacy** → **Pull**.
2. **Activate both sets:** In the Token Studio **Sets** panel, **check** both **`primitives`** and **`semantic`** (both must be active). If either is unchecked, the plugin may not export them or may not create variable references.
3. **Export to Figma** → **Options**: check **Variables** (Color, String, Number, Boolean). Leave **Styles** (Color, Typography, Effects) **unchecked**. Confirm → **Token Sets**: select **both `primitives` and `semantic`** → Export.
4. In Figma’s **Variables** panel you should see two collections (primitives, semantic) with semantic Variables **referencing** primitive Variables. If they still show hex: ensure both sets were checked before export; delete existing variable collections and export again.

**Fallback: semantics as Styles** (if Variables still resolve to hex): export primitives as Variables, then semantic as Styles with “Create styles with variable references” on (two-step export; see Token Studio docs).

## Token structure (required for the pipeline)

The build script expects this shape so it can resolve references and generate CSS + Tailwind:

1. **Top-level groups**: `primitives` and `semantic`.
2. **Token format**: Each token is an object with a value and type. **Both formats are supported:**
   - **Legacy (Token Studio default):** `value` and `type` (e.g. `"value": "#FFFFFF"`, `"type": "color"`).
   - **W3C DTCG:** `$value` and `$type` (e.g. `"$value": "#FFFFFF"`, `"$type": "color"`).
   You can convert to W3C in Token Studio (“Convert to W3C DTCG format”); the pipeline accepts both.
3. **References**: Use `{primitives.colors.white}` or `{primitives.space.m}` so semantic tokens point at primitives. References are resolved at build time.

Example:

```json
{
  "primitives": {
    "colors": {
      "white": { "value": "#FFFFFF", "type": "color" }
    },
    "space": {
      "m": { "value": "1rem", "type": "spacing" }
    }
  },
  "semantic": {
    "color": {
      "background": {
        "default": { "value": "{primitives.colors.white}", "type": "color" }
      }
    }
  }
}
```

## Token Studio (optional)

You don't need Token Studio for Obra → Storybook. If you use **Token Studio** (e.g. to push tokens into a different Figma file):

1. **Sync target**: Point the plugin’s sync path at **`tokens/joe-tokens-legacy.json`** (path relative to repo). Set **Token format** to **Legacy**. The legacy file has **two sets** (`primitives`, `semantic`); **check both** and export as Variables (see **Designer workflow** above).
2. **Source of truth**: `joe-tokens.json` (with `primitives` and `semantic`) is the source of truth for the build and Storybook. The legacy file is **generated** from it (same two-set structure, Legacy format). Do not edit the legacy file; edit `joe-tokens.json` and run `npm run tokens:build`.
3. **If you pull tokens from Figma**: If the plugin exports a different structure, add a conversion step so the result matches `joe-tokens.json` (top-level `primitives` and `semantic`, references as `{primitives.xxx}`) before running `tokens:build`.

After any change to `joe-tokens.json`, run **`npm run tokens:build`** and commit the generated files; see **Recommended approach** above.

### Troubleshooting

- **Semantic variables show hex instead of referencing primitives (Variables panel)**  
  Ensure you **Pull** the latest **`tokens/joe-tokens-legacy.json`** (two sets: **primitives** and **semantic**, refs `{primitives.xxx}`). In Token Studio **Sets**, **check both** **`primitives`** and **`semantic`** so they are active, then export **Variables** (Color, String, Number, Boolean); do not use Styles for color if you want semantics in the Variables panel. If semantic Variables still show hex: in Figma, **delete** the existing primitives and semantic collections, then run the export again with both sets checked. If it still fails, use the **Styles fallback** (primitives as Variables, then semantic as Styles with variable references).

- **“When I check Styles Color, Variables Color gets unchecked”**  
  This is **by design**. Token Studio allows color tokens to be exported as **either** Variables **or** Styles, not both, so the plugin toggles one off when you turn the other on.

- **Styles empty or not linked to variables** (when using Styles fallback)  
  Sync from **`tokens/joe-tokens-legacy.json`** with **Token format = Legacy**. Export primitives as Variables first, then semantic as Styles. In “Change Sets”, set `primitives` to **Reference only** and `semantic` to **Enabled** for the Styles export. If styles still show hex, run the Styles export again (plugin sometimes needs two passes to attach variable references).

### Light / dark mode (when you extend tokens)

When you add themes, use **Token Studio Themes (Pro)** and **Export to Figma from Themes** so the variable collection gets modes (e.g. Light, Dark). Variables and styles will then switch with the mode. You can also add a second mode to the collection in Figma and set values manually.

## Extending the token set

- **Primitives**: Add under `primitives` (e.g. `primitives.colors`, `primitives.space`, `primitives.radii`, `primitives.fontSizes`). The build script already maps these to CSS variables and Tailwind theme.
- **Semantic**: Add under `semantic.color` (or other semantic groups the script supports). Prefer referencing primitives, e.g. `"value": "{primitives.colors.blue.500}"`.
- **New categories**: If you add new top-level sections (e.g. `semantic.shadow`), you may need to extend `scripts/build-tokens.mjs` to emit CSS and/or Tailwind for them.

The current set covers: **Button** (primary, secondary, outline, ghost, destructive, icon), and the semantic color/space/typography/radius tokens used by the UI components and `app/globals.css`. It can be extended for Input, Card, Badge, Alert, etc. as needed.

