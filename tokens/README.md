# Joe Design System – Tokens

This folder is the **single source of truth** for design token.

Generated output is used by: **Next.js** and **Storybook**, and by **`app/globals.css`**.

## Files

| File | Role |
|------|------|
| `joe-tokens.json` | Source tokens (W3C format). Edited by designers/devs or synced from Figma (e.g. Token Studio). |
| `joe-tokens-legacy.json` | Legacy-format copy for Token Studio sync. Generated by `npm run tokens:build` (and `tokens:legacy`). Contains `primitives`, `semantic`, and `$metadata.tokenSetOrder: ["primitives", "semantic"]` so Token Studio exports primitives first (required for semantic Variables to alias primitive Variables). Commit this file so designers can sync from it. |
| `output/css/variables.css` | Generated CSS custom properties (DO NOT EDIT THIS!!). |
| `output/tailwind/theme.cjs` | Generated Tailwind theme (DO NOT EDIT THIS!!!). |

Generated files are produced by `npm run tokens:build` (see `scripts/build-tokens.mjs`). The build also generates `joe-tokens-legacy.json` for Figma/Token Studio.

## Recommended approach: Figma + Storybook in sync

**Goals:** Storybook keeps working, tokens stay in sync with Figma, and designers get **semantics referencing primitives** in Figma via Token Studio’s supported workflow.

### Why Do We Have joe-tokens.json And joe-tokens-legacy.json

- **Single source of truth:** `joe-tokens.json` (W3C). Build produces CSS, Tailwind theme, **and** `joe-tokens-legacy.json`.
- **Storybook:** Uses `tokens/output/` from `tokens:build`; no dependency on Legacy.
- **Figma / designers:** Token Studio syncs from **`tokens/joe-tokens-legacy.json`** with **Token format = Legacy**. The legacy file includes **`$metadata.tokenSetOrder: ["primitives", "semantic"]`** so that when you export **both** sets as Variables, primitives are created first and semantic Variables can alias them in the Variables panel. After any change to `joe-tokens.json`, run **`npm run tokens:build`** and commit; designers pull and re-export to Figma.

### Export order and variable-to-variable references (Variables panel)

- **Goal:** Semantic **Variables** in Figma’s Variables panel should reference primitive Variables (alias), not resolved hex. With the same plugin version and GitHub + Legacy sync, this can work if Token Studio exports **primitives first**, then semantic, so that when semantic variables are created the referenced primitive variables already exist.
- **What we do:** `joe-tokens-legacy.json` includes **`$metadata.tokenSetOrder: ["primitives", "semantic"]`** so Token Studio uses that order for sets. When you export **both** sets as Variables, primitives are exported first; semantic variables can then be created as aliases to those primitive variables. After pulling the latest legacy file, export **Variables** (Color, String, Number, Boolean) with **both** `primitives` and `semantic` selected. If semantic variables still show hex, try removing existing Figma variable collections and exporting again so the plugin creates them in order.
- **Color: Variables vs Styles:** In Export Options, **Color** can be exported as either **Variables** or **Styles**, not both. Token Studio’s docs state: *“color can not be exported to Variables and Styles at the same time as the Plugin won't know which property in Figma to attach the Tokens To.”* So when you check **Styles → Color**, the plugin unchecks **Variables → Color** (and vice versa). That behavior is intentional. For semantics as **Variables** (not Styles), keep **Variables → Color** on and **Styles → Color** off.

### Designer workflow (Figma) – semantics as Variables referencing primitives

**Preferred: both sets as Variables (semantics as aliases in Variables panel)**

1. **Sync**: Token Studio → connect to repo, path **`tokens/joe-tokens-legacy.json`**, **Token format = Legacy** → **Pull** (ensures you have the latest file with `$metadata.tokenSetOrder`).
2. **Export to Figma** → **Options**: check **Variables** (Color, String, Number, Boolean). Leave **Styles** (Color, Typography, Effects) **unchecked**. Confirm → **Token Sets**: select **both `primitives` and `semantic`** → Export.
3. Token Studio uses `tokenSetOrder` so **primitives** are exported first, then **semantic**. In Figma’s **Variables** panel, semantic variables should appear as references (aliases) to primitive variables. If they still show resolved hex: delete the existing “primitives” and “semantic” variable collections in Figma, then run the export again so the plugin creates them in the correct order.

**Fallback: semantics as Styles (if Variables still resolve to hex)**

4. **Step 1** – Export **only `primitives`** as Variables (Options: Variables on, Styles off).
5. **Step 2** – Export **semantic** as Styles: Options → Variables → Color **off**, Styles → Color **on**, “Create styles with variable references” **on**. **Change Sets**: `primitives` = Reference only, `semantic` = Enabled. Export. Semantic Color Styles will reference primitive Variables in the Styles panel.

## Token structure (required for the pipeline)

The build script expects this shape so it can resolve references and generate CSS + Tailwind:

1. **Top-level groups**: `primitives` and `semantic`.
2. **Token format**: Each token is an object with a value and type. **Both formats are supported:**
   - **Legacy (Token Studio default):** `value` and `type` (e.g. `"value": "#FFFFFF"`, `"type": "color"`).
   - **W3C DTCG:** `$value` and `$type` (e.g. `"$value": "#FFFFFF"`, `"$type": "color"`).
   You can convert to W3C in Token Studio (“Convert to W3C DTCG format”); the pipeline accepts both.
3. **References**: Use `{primitives.colors.white}` or `{primitives.space.m}` so semantic tokens point at primitives. References are resolved at build time.

Example:

```json
{
  "primitives": {
    "colors": {
      "white": { "value": "#FFFFFF", "type": "color" }
    },
    "space": {
      "m": { "value": "1rem", "type": "spacing" }
    }
  },
  "semantic": {
    "color": {
      "background": {
        "default": { "value": "{primitives.colors.white}", "type": "color" }
      }
    }
  }
}
```

## Token Studio (Figma) alignment

If you use the **Token Studio** plugin in Figma:

1. **Sync target**: Point the plugin’s sync path at **`tokens/joe-tokens-legacy.json`** (path relative to repo). Set **Token format** to **Legacy**. Export **both** primitives and semantic as Variables (see **Designer workflow** above); tokenSetOrder ensures primitives are exported first so semantic Variables can reference them. If semantic Variables still show hex, use the Styles fallback.
2. **Structure**: Configure the plugin so the exported JSON has:
   - Root keys: `primitives` and `semantic` (or map your groups to these names in a post-step).
   - Each token as `{ "value": "...", "type": "..." }`.
   - References in the form `{primitives.xxx.yyy}`.
3. **If the plugin uses another format** (e.g. W3C design tokens): keep `joe-tokens.json` as the source of truth in the repo and either:
   - Change the plugin’s output format to match the structure above, or
   - Add a small conversion script that transforms the plugin’s export into `joe-tokens.json` before running `tokens:build`.

After any change to `joe-tokens.json`, run **`npm run tokens:build`** and commit the generated files; see **Recommended approach** above.

### Troubleshooting

- **Semantic variables show hex instead of referencing primitives (Variables panel)**  
  Ensure you **Pull** the latest **`tokens/joe-tokens-legacy.json`** (it must include **`$metadata.tokenSetOrder: ["primitives", "semantic"]`**). Export **both** primitives and semantic as **Variables** in one go; do not use Styles for color if you want semantics in the Variables panel. If semantic Variables still show hex: in Figma, **delete** the existing “primitives” and “semantic” variable collections, then run the export again so the plugin creates them in order (primitives first). If it still fails, use the **Styles fallback** (primitives as Variables, then semantic as Styles with variable references).

- **“When I check Styles Color, Variables Color gets unchecked”**  
  This is **by design**. Token Studio allows color tokens to be exported as **either** Variables **or** Styles, not both, so the plugin toggles one off when you turn the other on.

- **Styles empty or not linked to variables** (when using Styles fallback)  
  Sync from **`tokens/joe-tokens-legacy.json`** with **Token format = Legacy**. Export primitives as Variables first, then semantic as Styles. In “Change Sets”, set `primitives` to **Reference only** and `semantic` to **Enabled** for the Styles export. If styles still show hex, run the Styles export again (plugin sometimes needs two passes to attach variable references).

### Light / dark mode (when you extend tokens)

When you add themes, use **Token Studio Themes (Pro)** and **Export to Figma from Themes** so the variable collection gets modes (e.g. Light, Dark). Variables and styles will then switch with the mode. You can also add a second mode to the collection in Figma and set values manually.

## Extending the token set

- **Primitives**: Add under `primitives` (e.g. `primitives.colors`, `primitives.space`, `primitives.radii`, `primitives.fontSizes`). The build script already maps these to CSS variables and Tailwind theme.
- **Semantic**: Add under `semantic.color` (or other semantic groups the script supports). Prefer referencing primitives, e.g. `"value": "{primitives.colors.blue.500}"`.
- **New categories**: If you add new top-level sections (e.g. `semantic.shadow`), you may need to extend `scripts/build-tokens.mjs` to emit CSS and/or Tailwind for them.

The current set covers: **Button** (primary, secondary, outline, ghost, destructive, icon), and the semantic color/space/typography/radius tokens used by the UI components and `app/globals.css`. It can be extended for Input, Card, Badge, Alert, etc. as needed.

