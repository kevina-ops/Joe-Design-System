# Joe Design System – Tokens

This folder is the **single source of truth** for design token.

Generated output is used by: **Next.js** and **Storybook**, and by **`app/globals.css`**.

## Files

| File | Role |
|------|------|
| `joe-tokens.json` | Source tokens (W3C format). Edited by designers/devs or synced from Figma (e.g. Token Studio). |
| `joe-tokens-legacy.json` | Legacy-format copy for Token Studio sync. Generated by `npm run tokens:build` (and `tokens:legacy`). Contains **only** `primitives` and `semantic` (no `$themes`/`$metadata`) so Token Studio can preserve variable-to-variable references when you export both sets as Variables. Commit this file so designers can sync from it. |
| `output/css/variables.css` | Generated CSS custom properties (DO NOT EDIT THIS!!). |
| `output/tailwind/theme.cjs` | Generated Tailwind theme (DO NOT EDIT THIS!!!). |

Generated files are produced by `npm run tokens:build` (see `scripts/build-tokens.mjs`). The build also generates `joe-tokens-legacy.json` for Figma/Token Studio.

## Recommended approach: Figma + Storybook in sync

**Goals:** Storybook keeps working, tokens stay in sync with Figma, and designers get primitives + semantic variables in Figma with **semantics referencing primitives** in the Variables panel (same behavior as a Legacy token file that has only `primitives` and `semantic`).

### Why Do We Have joe-tokens.json And joe-tokens-legacy.json

- **Single source of truth:** `joe-tokens.json` (W3C). Build produces CSS, Tailwind theme, **and** `joe-tokens-legacy.json`.
- **Storybook:** Uses `tokens/output/` from `tokens:build`; no dependency on Legacy.
- **Figma / designers:** Token Studio syncs from **`tokens/joe-tokens-legacy.json`** with **Token format = Legacy**. The legacy file is generated with **only** `primitives` and `semantic` (no `$themes` or `$metadata`), matching the structure that preserves variable-to-variable references when you export both sets as Variables. After any change to `joe-tokens.json`, run **`npm run tokens:build`** and commit; designers pull and re-export to Figma.

### Designer workflow (Figma) – semantics referencing primitives (Variables)

Use the same flow that works with a Legacy file containing only `primitives` and `semantic`:

1. **Sync**: Token Studio → connect to repo, path **`tokens/joe-tokens-legacy.json`**, **Token format = Legacy** → **Pull**.
2. **Export both sets as Variables**: **Export to Figma** → **Options**: check **Variables** (Color, String, Number, Boolean). Select **Token Sets** and check **both `primitives` and `semantic`** → Export.
3. In Figma, the **Variables** panel should show primitives and semantic, with semantic variables **referencing** primitive variables (e.g. semantic “background default” → primitives white), not resolved hex.

If your Token Studio version resolves references when exporting Variables (semantic variables show hex instead of aliases), use the **Styles** fallback below.

### Fallback: semantics via Styles (variable references)

If exporting both sets as Variables still shows resolved hex for semantic variables:

1. **Export primitives as Variables only**: Options → Variables on, Styles off. Export **only `primitives`**.
2. **Export semantic as Styles**: Options → Variables > Color off, Styles > Color on, “Create styles with variable references” on. **Change Sets**: `primitives` = Reference only, `semantic` = Enabled. Export **semantic**. Semantic Color Styles will reference primitive Variables in the Styles panel.

## Token structure (required for the pipeline)

The build script expects this shape so it can resolve references and generate CSS + Tailwind:

1. **Top-level groups**: `primitives` and `semantic`.
2. **Token format**: Each token is an object with a value and type. **Both formats are supported:**
   - **Legacy (Token Studio default):** `value` and `type` (e.g. `"value": "#FFFFFF"`, `"type": "color"`).
   - **W3C DTCG:** `$value` and `$type` (e.g. `"$value": "#FFFFFF"`, `"$type": "color"`).
   You can convert to W3C in Token Studio (“Convert to W3C DTCG format”); the pipeline accepts both.
3. **References**: Use `{primitives.colors.white}` or `{primitives.space.m}` so semantic tokens point at primitives. References are resolved at build time.

Example:

```json
{
  "primitives": {
    "colors": {
      "white": { "value": "#FFFFFF", "type": "color" }
    },
    "space": {
      "m": { "value": "1rem", "type": "spacing" }
    }
  },
  "semantic": {
    "color": {
      "background": {
        "default": { "value": "{primitives.colors.white}", "type": "color" }
      }
    }
  }
}
```

## Token Studio (Figma) alignment

If you use the **Token Studio** plugin in Figma:

1. **Sync target**: Point the plugin’s sync path at **`tokens/joe-tokens-legacy.json`** (path relative to repo). Set **Token format** to **Legacy**. Export both **primitives** and **semantic** as Variables in one go so semantics reference primitives in the Variables panel. If your plugin version resolves references, use the Styles fallback (primitives as Variables, then semantic as Styles with variable references).
2. **Structure**: Configure the plugin so the exported JSON has:
   - Root keys: `primitives` and `semantic` (or map your groups to these names in a post-step).
   - Each token as `{ "value": "...", "type": "..." }`.
   - References in the form `{primitives.xxx.yyy}`.
3. **If the plugin uses another format** (e.g. W3C design tokens): keep `joe-tokens.json` as the source of truth in the repo and either:
   - Change the plugin’s output format to match the structure above, or
   - Add a small conversion script that transforms the plugin’s export into `joe-tokens.json` before running `tokens:build`.

After any change to `joe-tokens.json`, run **`npm run tokens:build`** and commit the generated files; see **Recommended approach** above.

### Troubleshooting

- **Semantic variables show hex instead of referencing primitives**  
  Ensure you sync from **`tokens/joe-tokens-legacy.json`** (generated by `npm run tokens:build`) with **Token format = Legacy**. The legacy file must contain **only** `primitives` and `semantic` (no `$themes` or `$metadata`). Export **both** sets as Variables in one go. If your Token Studio version still resolves references, use the **Fallback: semantics via Styles** workflow above.

- **Styles empty or not linked to variables**  
  When using the Styles fallback: sync from **`tokens/joe-tokens-legacy.json`** with **Token format = Legacy**. In “Change Sets”, set `primitives` to **Reference only** and `semantic` to **Enabled** when exporting Styles. Export primitives as Variables first, then export semantic as Styles. If styles still show resolved values, run the Styles export again (plugin sometimes needs two passes to attach variable references).

### Light / dark mode (when you extend tokens)

When you add themes, use **Token Studio Themes (Pro)** and **Export to Figma from Themes** so the variable collection gets modes (e.g. Light, Dark). Variables and styles will then switch with the mode. You can also add a second mode to the collection in Figma and set values manually.

## Extending the token set

- **Primitives**: Add under `primitives` (e.g. `primitives.colors`, `primitives.space`, `primitives.radii`, `primitives.fontSizes`). The build script already maps these to CSS variables and Tailwind theme.
- **Semantic**: Add under `semantic.color` (or other semantic groups the script supports). Prefer referencing primitives, e.g. `"value": "{primitives.colors.blue.500}"`.
- **New categories**: If you add new top-level sections (e.g. `semantic.shadow`), you may need to extend `scripts/build-tokens.mjs` to emit CSS and/or Tailwind for them.

The current set covers: **Button** (primary, secondary, outline, ghost, destructive, icon), and the semantic color/space/typography/radius tokens used by the UI components and `app/globals.css`. It can be extended for Input, Card, Badge, Alert, etc. as needed.

