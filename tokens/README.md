# Joe Design System – Tokens

This folder is the **single source of truth** for design token.

Generated output is used by: **Next.js** and **Storybook**, and by **`app/globals.css`**.

## Files

| File | Role |
|------|------|
| `joe-tokens.json` | Source tokens (W3C format). Edited by designers/devs or synced from Figma (e.g. Token Studio). |
| `joe-tokens-legacy.json` | Legacy-format copy for Token Studio sync. Generated by `npm run tokens:build` (and `tokens:legacy`). Contains a **single token set `joe`** (primitives + semantic in one set) with references as `{joe.colors.white}` etc., so Token Studio creates one Figma variable collection and semantic Variables can alias primitive Variables within it. **Do not edit**; commit so designers can sync from it. |
| `output/css/variables.css` | Generated CSS custom properties (DO NOT EDIT THIS!!). |
| `output/tailwind/theme.cjs` | Generated Tailwind theme (DO NOT EDIT THIS!!!). |

Generated files are produced by `npm run tokens:build` (see `scripts/build-tokens.mjs`). The build also generates `joe-tokens-legacy.json` for Figma/Token Studio.

## Recommended approach: Figma + Storybook in sync

**Goals:** Storybook keeps working, tokens stay in sync with Figma, and designers get **semantics referencing primitives** in Figma via Token Studio’s supported workflow.

### Why Do We Have joe-tokens.json And joe-tokens-legacy.json

- **Single source of truth:** `joe-tokens.json` (W3C). Build produces CSS, Tailwind theme, **and** `joe-tokens-legacy.json`.
- **Storybook:** Uses `tokens/output/` from `tokens:build`; no dependency on Legacy.
- **Figma / designers:** Token Studio syncs from **`tokens/joe-tokens-legacy.json`** with **Token format = Legacy**. The legacy file is generated with a **single token set `joe`** (primitives and semantic in one set, references as `{joe.colors.white}`) so that when you export that set as Variables, all tokens live in one Figma collection and semantic Variables can alias primitive Variables. **`joe-tokens.json` is unchanged**; Storybook and the build pipeline use it as-is. After any change to `joe-tokens.json`, run **`npm run tokens:build`** and commit; designers pull and re-export to Figma.

### Single token set for Figma (variable-to-variable references)

- **Why one set:** When Token Studio exports **two** sets (primitives, semantic) as Variables, it creates two Figma collections. References like `{primitives.colors.white}` from the semantic set point into the other collection; the plugin may resolve those to hex instead of creating variable aliases. With a **single** set **`joe`**, primitives and semantic live in one collection; references like `{joe.colors.white}` point to tokens in the same set, so the plugin can create variable aliases within that collection.
- **What we do:** The legacy export script builds **`joe-tokens-legacy.json`** with one set **`joe`**: primitives at top level (colors, fonts, fontSizes, …) and **semantic** nested under it. All references are rewritten from `{primitives.xxx}` to `{joe.xxx}`. **`joe-tokens.json`** stays with `primitives` and `semantic` and `{primitives.xxx}`; only the legacy file structure changes for Figma.
- **Color: Variables vs Styles:** In Export Options, **Color** can be exported as either **Variables** or **Styles**, not both. For semantics as **Variables** (referencing primitives in the Variables panel), keep **Variables → Color** on and **Styles → Color** off.

### Designer workflow (Figma) – semantics as Variables referencing primitives

1. **Sync**: Token Studio → connect to repo, path **`tokens/joe-tokens-legacy.json`**, **Token format = Legacy** → **Pull**.
2. **Activate the set:** In the Token Studio **Sets** panel, **check** the **`joe`** set (so it is active). Both primitives and semantic are in this one set.
3. **Export to Figma** → **Options**: check **Variables** (Color, String, Number, Boolean). Leave **Styles** (Color, Typography, Effects) **unchecked**. Confirm → **Token Sets**: select **`joe`** → Export.
4. In Figma’s **Variables** panel you should see one collection (e.g. “joe”) with primitive and semantic variables; semantic variables should show as **references** (aliases) to primitive variables. If they still show hex: delete the existing “joe” (or primitives/semantic) variable collection in Figma and export again.

**Fallback: semantics as Styles** (if Variables still resolve to hex): export primitives as Variables from one setup, then semantic as Styles with “Create styles with variable references” on (two-step export; see Token Studio docs).

## Token structure (required for the pipeline)

The build script expects this shape so it can resolve references and generate CSS + Tailwind:

1. **Top-level groups**: `primitives` and `semantic`.
2. **Token format**: Each token is an object with a value and type. **Both formats are supported:**
   - **Legacy (Token Studio default):** `value` and `type` (e.g. `"value": "#FFFFFF"`, `"type": "color"`).
   - **W3C DTCG:** `$value` and `$type` (e.g. `"$value": "#FFFFFF"`, `"$type": "color"`).
   You can convert to W3C in Token Studio (“Convert to W3C DTCG format”); the pipeline accepts both.
3. **References**: Use `{primitives.colors.white}` or `{primitives.space.m}` so semantic tokens point at primitives. References are resolved at build time.

Example:

```json
{
  "primitives": {
    "colors": {
      "white": { "value": "#FFFFFF", "type": "color" }
    },
    "space": {
      "m": { "value": "1rem", "type": "spacing" }
    }
  },
  "semantic": {
    "color": {
      "background": {
        "default": { "value": "{primitives.colors.white}", "type": "color" }
      }
    }
  }
}
```

## Token Studio (Figma) alignment

If you use the **Token Studio** plugin in Figma:

1. **Sync target**: Point the plugin’s sync path at **`tokens/joe-tokens-legacy.json`** (path relative to repo). Set **Token format** to **Legacy**. The legacy file has a **single set `joe`**; check that set and export as Variables (see **Designer workflow** above).
2. **Source of truth**: `joe-tokens.json` (with `primitives` and `semantic`) is the source of truth for the build and Storybook. The legacy file is **generated** from it (single set, references rewritten to `{joe.xxx}`). Do not edit the legacy file; edit `joe-tokens.json` and run `npm run tokens:build`.
3. **If you pull tokens from Figma**: If the plugin exports a different structure, add a conversion step so the result matches `joe-tokens.json` (top-level `primitives` and `semantic`, references as `{primitives.xxx}`) before running `tokens:build`.

After any change to `joe-tokens.json`, run **`npm run tokens:build`** and commit the generated files; see **Recommended approach** above.

### Troubleshooting

- **Semantic variables show hex instead of referencing primitives (Variables panel)**  
  Ensure you **Pull** the latest **`tokens/joe-tokens-legacy.json`** (single set **`joe`** with references like `{joe.colors.white}`). In Token Studio **Sets**, **check** the **`joe`** set so it is active, then export **Variables** (Color, String, Number, Boolean); do not use Styles for color if you want semantics in the Variables panel. If semantic Variables still show hex: in Figma, **delete** the existing variable collection (e.g. “joe”), then run the export again. If it still fails, use the **Styles fallback** (primitives as Variables, then semantic as Styles with variable references).

- **“When I check Styles Color, Variables Color gets unchecked”**  
  This is **by design**. Token Studio allows color tokens to be exported as **either** Variables **or** Styles, not both, so the plugin toggles one off when you turn the other on.

- **Styles empty or not linked to variables** (when using Styles fallback)  
  Sync from **`tokens/joe-tokens-legacy.json`** with **Token format = Legacy**. Export primitives as Variables first, then semantic as Styles. In “Change Sets”, set `primitives` to **Reference only** and `semantic` to **Enabled** for the Styles export. If styles still show hex, run the Styles export again (plugin sometimes needs two passes to attach variable references).

### Light / dark mode (when you extend tokens)

When you add themes, use **Token Studio Themes (Pro)** and **Export to Figma from Themes** so the variable collection gets modes (e.g. Light, Dark). Variables and styles will then switch with the mode. You can also add a second mode to the collection in Figma and set values manually.

## Extending the token set

- **Primitives**: Add under `primitives` (e.g. `primitives.colors`, `primitives.space`, `primitives.radii`, `primitives.fontSizes`). The build script already maps these to CSS variables and Tailwind theme.
- **Semantic**: Add under `semantic.color` (or other semantic groups the script supports). Prefer referencing primitives, e.g. `"value": "{primitives.colors.blue.500}"`.
- **New categories**: If you add new top-level sections (e.g. `semantic.shadow`), you may need to extend `scripts/build-tokens.mjs` to emit CSS and/or Tailwind for them.

The current set covers: **Button** (primary, secondary, outline, ghost, destructive, icon), and the semantic color/space/typography/radius tokens used by the UI components and `app/globals.css`. It can be extended for Input, Card, Badge, Alert, etc. as needed.

